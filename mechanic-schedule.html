<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch làm việc - Sửa Xe Nhanh</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/mechanic-schedule.css">
    
    <script src="js/common-header.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapsed">
                <div class="position-sticky">
                    <div class="text-center py-4 mb-3">
                        <img src="images/maintenance.png" alt="Logo" width="50" height="50">
                        <h5 class="text-white mt-2">Kỹ thuật viên</h5>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="mechanic-dashboard.html" id="dashboard-link">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="mechanic-appointments.html" id="appointments-link">
                                <i class="bi bi-calendar-check me-2"></i>
                                Quản lý Lịch hẹn
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="mechanic-schedule.html" id="schedule-link">
                                <i class="bi bi-calendar-week me-2"></i>
                                Lịch làm việc
                            </a>
                        </li>
                        
                        <li class="nav-item mt-4">
                            <a class="nav-link text-danger" href="#" id="sidebar-logout">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                Đăng xuất
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Quản lý lịch làm việc</h1>
                    <div class="user-info d-flex align-items-center">
                        <span class="me-2" id="mechanicName">Kỹ thuật viên</span>
                        <div class="dropdown">
                            <a href="#" class="d-block link-dark text-decoration-none dropdown-toggle" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="avatar-placeholder" id="avatarPlaceholder">K</div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end text-small" aria-labelledby="dropdownUser">
                                <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Hồ sơ</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logout-link"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Thông báo -->
                <div class="alert alert-success alert-dismissible fade show d-none" id="successAlert" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span id="successMessage">Thành công!</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <div class="alert alert-danger alert-dismissible fade show d-none" id="errorAlert" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span id="errorMessage">Lỗi!</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

<!-- THAY THẾ TỪ DÒNG 96 ĐẾN HẾT 2 BẢNG -->

<!-- TABS NAVIGATION -->
<div class="mb-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <!-- Tab Buttons -->
        <div class="btn-group" role="group" aria-label="View toggle">
            <button type="button" class="btn btn-outline-primary active" id="tabMySchedule">
                <i class="bi bi-calendar-check me-2"></i>Lịch của tôi
            </button>
            <button type="button" class="btn btn-outline-primary" id="tabTeamSchedule">
                <i class="bi bi-people me-2"></i>Lịch team
            </button>
        </div>
        
        <!-- Action Buttons (hiển thị tùy theo tab) -->
        <div id="myScheduleActions">
            <button class="btn btn-primary" id="addScheduleBtn">
                <i class="bi bi-plus-circle me-1"></i> Đăng ký lịch mới
            </button>
            <button class="btn btn-outline-secondary ms-2" id="refreshScheduleBtn">
                <i class="bi bi-arrow-clockwise"></i> Làm mới
            </button>
        </div>
        
        <div id="teamScheduleActions" style="display: none;">
            <button class="btn btn-success" id="addScheduleFromWeeklyBtn">
                <i class="bi bi-plus-circle me-1"></i> Thêm lịch
            </button>
        </div>
    </div>
</div>

<!-- THAY THẾ SECTION "Lịch của tôi" TRONG FILE TABS -->

<!-- SECTION 1: LỊCH CỦA TÔI (List View - CHỈ HIỂN THỊ NGÀY CÓ LỊCH) -->
<div id="myScheduleSection" class="schedule-section">
    <!-- Header với navigation -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="m-0 font-weight-bold">
                    <i class="bi bi-calendar-check me-2"></i>Lịch làm việc của tôi
                </h5>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Month navigation -->
                    <button class="btn btn-outline-secondary btn-sm" id="prevMonthBtn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <span id="currentMonthText" class="fw-bold px-3">Tháng 11/2025</span>
                    <button class="btn btn-outline-secondary btn-sm" id="nextMonthBtn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm ms-2" id="todayBtn">
                        <i class="bi bi-calendar-today me-1"></i>Hôm nay
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <!-- Legend -->
            <div class="mb-3 pb-3 border-bottom">
                <div class="d-flex flex-wrap gap-3">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2" style="width: 12px; height: 12px; border-radius: 50%;"></span>
                        <small class="text-muted">Lịch làm việc</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-warning me-2" style="width: 12px; height: 12px; border-radius: 50%;"></span>
                        <small class="text-muted">Lịch hẹn</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-secondary me-2" style="width: 12px; height: 12px; border-radius: 50%;"></span>
                        <small class="text-muted">Không làm việc</small>
                    </div>
                </div>
            </div>
            
            <!-- Schedule List (CHỈ NGÀY CÓ LỊCH) -->
            <div id="scheduleListContainer">
                <!-- Loading state -->
                <div id="scheduleLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2 text-muted">Đang tải lịch làm việc...</p>
                </div>
                
                <!-- Empty state -->
                <div id="scheduleEmpty" class="text-center py-5" style="display: none;">
                    <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-muted">Chưa có lịch làm việc nào trong tháng này</p>
                    <button class="btn btn-primary mt-2" id="addScheduleFromEmptyBtn">
                        <i class="bi bi-plus-circle me-1"></i> Đăng ký lịch mới
                    </button>
                </div>
                
                <!-- Schedule list (render by JS) -->
                <div id="scheduleList">
                    <!-- JS sẽ render vào đây -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS cho List View -->
<style>
/* Schedule List Styles */
.schedule-date-group {
    margin-bottom: 2rem;
}

.schedule-date-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.schedule-date-header h6 {
    margin: 0;
    font-weight: 600;
    font-size: 1rem;
}

.schedule-date-header small {
    opacity: 0.9;
}

.schedule-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.schedule-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    border-color: #667eea;
}

.schedule-card-time {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.schedule-card-time i {
    color: #667eea;
    margin-right: 8px;
}

.schedule-card-type {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 8px;
}

.schedule-card-type.work {
    background-color: #d4edda;
    color: #155724;
}

.schedule-card-type.appointment {
    background-color: #fff3cd;
    color: #856404;
}

.schedule-card-type.unavailable {
    background-color: #e2e3e5;
    color: #383d41;
}

.schedule-card-notes {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #f0f0f0;
}

.schedule-card-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
}

.schedule-card-actions .btn {
    flex: 1;
    font-size: 0.875rem;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .schedule-date-header {
        padding: 10px 16px;
    }
    
    .schedule-card {
        padding: 12px 16px;
    }
    
    .schedule-card-time {
        font-size: 1rem;
    }
    
    .schedule-card-actions {
        flex-direction: column;
    }
    
    .schedule-card-actions .btn {
        width: 100%;
    }
}

/* Animation */
.schedule-fade-in {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>


<!-- SECTION 2: LỊCH TEAM (Table View) -->
<div id="teamScheduleSection" class="schedule-section" style="display: none;">
    <!-- Lịch trình tuần - TẤT CẢ KỸ THUẬT VIÊN -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h5 class="m-0 font-weight-bold">
                <i class="bi bi-people me-2"></i>Lịch trình tuần - Tất cả kỹ thuật viên
            </h5>
        </div>
        <div class="card-body">
            <!-- Navigation tuần -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-outline-primary" id="prevWeekBtn">
                    <i class="bi bi-chevron-left"></i> Tuần trước
                </button>
                <h6 class="mb-0" id="weekRangeText">01-12-2025 - 07-12-2025</h6>
                <button class="btn btn-outline-primary" id="nextWeekBtn">
                    Tuần sau <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <!-- Bảng lịch tuần -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="weeklyScheduleTable">
                    <thead class="table-light">
                        <tr>
                            <th style="min-width: 150px;">Kỹ thuật viên</th>
                            <th class="text-center">Thứ Hai<br><small id="day1"></small></th>
                            <th class="text-center">Thứ Ba<br><small id="day2"></small></th>
                            <th class="text-center">Thứ Tư<br><small id="day3"></small></th>
                            <th class="text-center">Thứ Năm<br><small id="day4"></small></th>
                            <th class="text-center">Thứ Sáu<br><small id="day5"></small></th>
                            <th class="text-center">Thứ Bảy<br><small id="day6"></small></th>
                            <th class="text-center">Chủ Nhật<br><small id="day7"></small></th>
                        </tr>
                    </thead>
                    <tbody id="weeklyScheduleBody">
                        <!-- Data sẽ được render bằng JS -->
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Ghi chú -->
            <div class="mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    + <span id="hiddenMechanicsCount">0</span> kỹ thuật viên khác. 
                    Sử dụng chức năng "Xem tất cả kỹ thuật viên" để xem đầy đủ.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- CSS cho tabs -->
<style>
/* Tab buttons */
.btn-group .btn {
    border-radius: 0;
    padding: 10px 20px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-group .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.btn-group .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.btn-group .btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.btn-group .btn:not(.active):hover {
    background-color: #e7f1ff;
}

/* Schedule sections */
.schedule-section {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Highlight current mechanic row in team schedule */
.my-schedule-row {
    background-color: #fff3cd !important;
    font-weight: 600;
}

.my-schedule-row td {
    border-left: 3px solid #ffc107;
}
</style>


                <!-- Lịch làm việc đã đăng ký -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h5 class="m-0 font-weight-bold">Lịch đã đăng ký gần đây</h5>
                        <button class="btn btn-sm btn-outline-primary" id="viewAllSchedulesBtn">
                            <i class="bi bi-calendar-week me-1"></i> Xem tất cả
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Mã lịch</th>
                                        <th>Ngày làm</th>
                                        <th>Ca làm</th>
                                        <th>Trạng thái</th>
                                        <th>Ghi chú</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="schedulesList">
                                    <tr>
                                        <td colspan="6" class="text-center py-3">Đang tải dữ liệu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Đăng ký lịch làm việc - V2 FIXED -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">Đăng ký lịch làm việc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <input type="hidden" id="scheduleId">
                        <input type="hidden" id="isEditMode" value="false">
                        
                        <!-- Chọn ngày -->
                        <div class="mb-3">
                            <label for="scheduleDate" class="form-label">
                                Ngày làm việc <span class="text-danger">*</span>
                            </label>
                            <input type="date" class="form-control" id="scheduleDate" required>
                            <small class="text-muted">Chỉ có thể đăng ký trước 24 giờ</small>
                        </div>
                        
                        <!-- Chọn giờ -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <label for="startTime" class="form-label">
                                    Giờ bắt đầu <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="startTime" required>
                                    <option value="">-- Chọn giờ --</option>
                                    <option value="07:00">07:00 Sáng</option>
                                    <option value="08:00">08:00 Sáng</option>
                                    <option value="09:00">09:00 Sáng</option>
                                    <option value="10:00">10:00 Sáng</option>
                                    <option value="11:00">11:00 Sáng</option>
                                    <option value="12:00">12:00 Trưa</option>
                                    <option value="13:00">13:00 Chiều</option>
                                    <option value="14:00">14:00 Chiều</option>
                                    <option value="15:00">15:00 Chiều</option>
                                    <option value="16:00">16:00 Chiều</option>
                                    <option value="17:00">17:00 Chiều</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="endTime" class="form-label">
                                    Giờ kết thúc <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="endTime" required>
                                    <option value="">-- Chọn giờ --</option>
                                    <option value="08:00">08:00 Sáng</option>
                                    <option value="09:00">09:00 Sáng</option>
                                    <option value="10:00">10:00 Sáng</option>
                                    <option value="11:00">11:00 Sáng</option>
                                    <option value="12:00">12:00 Trưa</option>
                                    <option value="13:00">13:00 Chiều</option>
                                    <option value="14:00">14:00 Chiều</option>
                                    <option value="15:00">15:00 Chiều</option>
                                    <option value="16:00">16:00 Chiều</option>
                                    <option value="17:00">17:00 Chiều</option>
                                    <option value="18:00">18:00 Chiều</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Ghi chú/Lý do -->
                        <div class="mb-3">
                            <label for="scheduleNotes" class="form-label">
                                <span id="notesLabel">Ghi chú</span>
                            </label>
                            <textarea 
                                class="form-control" 
                                id="scheduleNotes" 
                                rows="3"
                                placeholder="VD: Ca sáng, ca chiều..."
                            ></textarea>
                            <small class="text-muted" id="notesHint">Thông tin thêm về ca làm việc (không bắt buộc)</small>
                        </div>
                        
                        <!-- Hiển thị trạng thái (chỉ khi edit) -->
                        <div class="mb-3" id="statusDisplay" style="display: none;">
                            <label class="form-label">Trạng thái hiện tại</label>
                            <div>
                                <span class="badge" id="statusBadge"></span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Đóng
                    </button>
                    <button type="button" class="btn btn-primary" id="saveScheduleBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="saveScheduleSpinner" role="status"></span>
                        <i class="bi bi-check-circle me-1"></i>
                        <span id="saveBtnText">Lưu lịch</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Xác nhận xóa lịch -->
    <!-- Modal Xin nghỉ -->
    <div class="modal fade" id="leaveRequestModal" tabindex="-1" aria-labelledby="leaveRequestModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="leaveRequestModalLabel">
                        <i class="bi bi-calendar-x me-2"></i>
                        Đăng ký xin nghỉ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Thông tin lịch đang xin nghỉ -->
                    <div class="leave-schedule-info mb-3 p-3 bg-light rounded border">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-calendar-event text-primary me-2 fs-5"></i>
                            <div>
                                <small class="text-muted d-block">Ngày làm việc</small>
                                <strong id="leaveScheduleDate">--/--/----</strong>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-clock text-primary me-2 fs-5"></i>
                            <div>
                                <small class="text-muted d-block">Ca làm việc</small>
                                <strong id="leaveScheduleTime">--:-- - --:--</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert thông báo -->
                    <div class="alert alert-info mb-3" style="background-color: #e8f4fd; border-color: #b6d4fe;">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Bạn đã đăng ký lịch này rồi.</strong> Nếu có việc bận đột xuất, vui lòng điền lý do bên dưới để xin nghỉ.
                    </div>
                    
                    <!-- Checkbox xác nhận (visual only) -->
                    <div class="form-check mb-3 p-3 rounded" style="background-color: #fef3c7; border: 1px solid #fcd34d;">
                        <input class="form-check-input" type="checkbox" id="confirmLeaveCheckbox" checked disabled>
                        <label class="form-check-label" for="confirmLeaveCheckbox">
                            <strong style="color: #92400e;">
                                <i class="bi bi-calendar-x me-1"></i>
                                Đăng ký nghỉ (có việc bận, không thể làm việc)
                            </strong>
                        </label>
                    </div>
                    
                    <small class="text-muted d-block mb-3">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Admin sẽ nhận được thông báo về đơn xin nghỉ của bạn
                    </small>
                    
                    <!-- Lý do xin nghỉ -->
                    <div class="mb-3">
                        <label for="leaveReason" class="form-label">
                            <strong>Lý do xin nghỉ</strong> <span class="text-danger">*</span>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="leaveReason" 
                            rows="3"
                            placeholder="VD: Có việc gia đình, khám bệnh, bận đột xuất..."
                            required
                            style="border-color: #fcd34d;"
                        ></textarea>
                        <small class="text-danger">
                            <strong><i class="bi bi-exclamation-circle me-1"></i>Vui lòng ghi rõ lý do để Admin dễ dàng xét duyệt</strong>
                        </small>
                    </div>
                    
                    <!-- Trạng thái sau khi gửi -->
                    <div class="mb-0">
                        <label class="form-label text-muted">Trạng thái sau khi gửi</label>
                        <div>
                            <span class="badge rounded-pill" style="background-color: #f59e0b; color: #1a1a1a; padding: 8px 16px; font-size: 0.85rem;">
                                <i class="bi bi-hourglass-split me-1"></i>
                                CHỜ DUYỆT
                            </span>
                        </div>
                    </div>
                    
                    <input type="hidden" id="leaveScheduleId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Đóng
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmLeaveRequestBtn" style="background-color: #f59e0b; border-color: #f59e0b; color: #1a1a1a;">
                        <span class="spinner-border spinner-border-sm d-none" id="leaveRequestSpinner" role="status"></span>
                        <i class="bi bi-send me-1"></i> Gửi đơn xin nghỉ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script giới hạn ngày đăng ký -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Giới hạn 24h
        const scheduleDateInput = document.getElementById('scheduleDate');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        scheduleDateInput.min = tomorrow.toISOString().split('T')[0];
        
        const maxDate = new Date(today);
        maxDate.setMonth(maxDate.getMonth() + 3);
        scheduleDateInput.max = maxDate.toISOString().split('T')[0];
    });
    </script>

    <!-- Modal Xin sửa lịch -->
    <div class="modal fade" id="editRequestModal" tabindex="-1" aria-labelledby="editRequestModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="editRequestModalLabel">
                        <i class="bi bi-pencil-square me-2"></i>
                        Xin sửa lịch làm việc
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Thông tin lịch hiện tại -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="edit-schedule-info p-3 bg-light rounded border">
                                <h6 class="text-muted mb-2"><i class="bi bi-calendar-event me-1"></i> Lịch hiện tại</h6>
                                <div class="d-flex align-items-center mb-2">
                                    <div>
                                        <small class="text-muted d-block">Ngày làm việc</small>
                                        <strong id="editCurrentDate">--/--/----</strong>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div>
                                        <small class="text-muted d-block">Ca làm việc</small>
                                        <strong id="editCurrentTime">--:-- - --:--</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="edit-schedule-info p-3 rounded border" style="background-color: #e0f2fe; border-color: #0ea5e9 !important;">
                                <h6 class="text-info mb-2"><i class="bi bi-arrow-right-circle me-1"></i> Lịch muốn đổi sang</h6>
                                <div class="mb-2">
                                    <label for="editNewDate" class="form-label small">Ngày mới <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control form-control-sm" id="editNewDate" required>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="editNewStartTime" class="form-label small">Từ <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control form-control-sm" id="editNewStartTime" value="08:00" required>
                                    </div>
                                    <div class="col-6">
                                        <label for="editNewEndTime" class="form-label small">Đến <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control form-control-sm" id="editNewEndTime" value="17:00" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert thông báo -->
                    <div class="alert alert-info mb-3" style="background-color: #e0f2fe; border-color: #0ea5e9;">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Bạn muốn thay đổi lịch làm việc?</strong> Vui lòng điền thông tin mới và lý do để Admin xét duyệt.
                    </div>
                    
                    <!-- Lưu ý quan trọng -->
                    <div class="alert alert-warning mb-3" style="background-color: #fef3c7; border-color: #fcd34d;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Lưu ý:</strong>
                        <ul class="mb-0 mt-1 small">
                            <li>Chỉ có thể xin sửa lịch <strong>trước 2 ngày</strong> kể từ ngày làm việc</li>
                            <li>Lịch đã có khách đặt <strong>không thể sửa</strong>, chỉ có thể xin nghỉ</li>
                            <li>Đơn xin sửa cần được <strong>Admin duyệt</strong> mới có hiệu lực</li>
                        </ul>
                    </div>
                    
                    <!-- Lý do xin sửa -->
                    <div class="mb-3">
                        <label for="editReason" class="form-label">
                            <strong>Lý do xin sửa lịch</strong> <span class="text-danger">*</span>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="editReason" 
                            rows="3"
                            placeholder="VD: Đổi ca để đi học, có việc gia đình vào ngày cũ..."
                            required
                            style="border-color: #0ea5e9;"
                        ></textarea>
                        <small class="text-info">
                            <strong><i class="bi bi-info-circle me-1"></i>Ghi rõ lý do để Admin dễ dàng xét duyệt</strong>
                        </small>
                    </div>
                    
                    <!-- Trạng thái sau khi gửi -->
                    <div class="mb-0">
                        <label class="form-label text-muted">Trạng thái sau khi gửi</label>
                        <div>
                            <span class="badge rounded-pill bg-info" style="padding: 8px 16px; font-size: 0.85rem;">
                                <i class="bi bi-hourglass-split me-1"></i>
                                CHỜ DUYỆT
                            </span>
                        </div>
                    </div>
                    
                    <input type="hidden" id="editScheduleId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Đóng
                    </button>
                    <button type="button" class="btn btn-info text-white" id="confirmEditRequestBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="editRequestSpinner" role="status"></span>
                        <i class="bi bi-send me-1"></i> Gửi đơn xin sửa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Thông báo khóa lịch -->
    <div class="modal fade" id="lockInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-lock-fill me-2"></i>
                        Lịch bị khóa
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-shield-lock text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <div class="alert alert-danger mb-3" id="lockReasonAlert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="lockReasonText">Lịch này đã bị khóa.</span>
                    </div>
                    <p class="text-muted mb-0" id="lockActionHint"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-warning" id="lockLeaveRequestBtn" style="display: none;">
                        <i class="bi bi-calendar-x me-1"></i> Xin nghỉ thay thế
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
    <!-- Custom JS -->
    <script src="js/config.js"></script>
    <script src="js/mechanic-schedule.js?v=perfect"></script>
</body>
</html>